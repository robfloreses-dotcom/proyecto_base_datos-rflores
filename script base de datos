CREATE SCHEMA IF NOT EXISTS rflores;

CREATE TABLE rflores.cliente (
  id_cliente SERIAL PRIMARY KEY,
  nombre VARCHAR(100) NOT NULL,
  email VARCHAR(100) UNIQUE NOT NULL,
  telefono VARCHAR(20),
  fecha_creacion DATE DEFAULT CURRENT_DATE
);

CREATE TABLE rflores.categoria (
  id_categoria SERIAL PRIMARY KEY,
  nombre VARCHAR(100) NOT NULL,
  fecha_creacion DATE DEFAULT CURRENT_DATE
);

CREATE TABLE rflores.producto (
  id_producto SERIAL PRIMARY KEY,
  nombre VARCHAR(100) NOT NULL,
  precio DECIMAL(10,2) NOT NULL,
  id_categoria INT NOT NULL,
  fecha_creacion DATE DEFAULT CURRENT_DATE,
  FOREIGN KEY (id_categoria) REFERENCES rflores.categoria(id_categoria)
);

CREATE TABLE rflores.venta (
  id_venta SERIAL PRIMARY KEY,
  id_cliente INT NOT NULL,
  fecha_venta DATE NOT NULL,
  total DECIMAL(10,2),
  FOREIGN KEY (id_cliente) REFERENCES rflores.cliente(id_cliente)
);

CREATE TABLE rflores.detalle_venta (
  id_detalle SERIAL PRIMARY KEY,
  id_venta INT NOT NULL,
  id_producto INT NOT NULL,
  cantidad INT NOT NULL,
  precio_unitario DECIMAL(10,2) NOT NULL,
  subtotal DECIMAL(10,2) NOT NULL,
  FOREIGN KEY (id_venta) REFERENCES rflores.venta(id_venta),
  FOREIGN KEY (id_producto) REFERENCES rflores.producto(id_producto)
);

INSERT INTO rflores.categoria (nombre)
VALUES ('Bebidas'), ('Snacks'), ('Limpieza'), ('Electr√≥nica'), ('Ropa');
INSERT INTO rflores.producto (nombre, precio, id_categoria)

SELECT
  'Producto ' || g,
  (random() * 50 + 1)::DECIMAL(10,2),
  (random() * 4 + 1)::INT
FROM generate_series(1,25) g;

INSERT INTO rflores.cliente (nombre, email, telefono)
SELECT
  'Cliente ' || g,
  'cliente' || g || '@mail.com',
  '099000' || g
FROM generate_series(1,30) g;

INSERT INTO rflores.venta (id_cliente, fecha_venta, total)
SELECT
  (random() * 29 + 1)::INT,
  DATE '2024-01-01' + (random() * 90)::INT,
  0
FROM generate_series(1,30);

INSERT INTO rflores.detalle_venta
(id_venta, id_producto, cantidad, precio_unitario, subtotal)
SELECT
  v.id_venta,
  p.id_producto,
  (random() * 5 + 1)::INT AS cantidad,
  p.precio AS precio_unitario,
  ((random() * 5 + 1)::INT * p.precio) AS subtotal
FROM generate_series(1,100)
JOIN rflores.venta v ON true
JOIN rflores.producto p ON true
ORDER BY random()
LIMIT 100;

SELECT DISTINCT c.nombre, v.fecha_venta
FROM rflores.cliente c
JOIN rflores.venta v ON c.id_cliente = v.id_cliente
WHERE v.fecha_venta BETWEEN '2024-01-01' AND '2024-03-31';

SELECT c.nombre, SUM(d.subtotal) AS total_comprado
FROM rflores.cliente c
JOIN rflores.venta v ON c.id_cliente = v.id_cliente
JOIN rflores.detalle_venta d ON v.id_venta = d.id_venta
GROUP BY c.nombre; 

SELECT p.nombre, SUM(d.cantidad) AS total_vendido
FROM rflores.producto p
JOIN rflores.detalle_venta d ON p.id_producto = d.id_producto
GROUP BY p.nombre
ORDER BY total_vendido DESC;
